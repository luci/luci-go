// Copyright 2025 The LUCI Authors.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package luci.analysis.bq.legacy;

import "google/protobuf/timestamp.proto";
import "go.chromium.org/luci/common/bq/pb/options.proto";
import "go.chromium.org/luci/analysis/proto/bq/legacy/ants_common.proto";

option go_package = "go.chromium.org/luci/analysis/proto/bq/legacy;bqpb";

// AntsTestResultRow represents a row in a BigQuery table for an AnTS test result.
// Next ID: 30.
message AntsTestResultRow {

  // The possible statuses that a TestResult can report.
  enum TestStatus {
    TEST_STATUS_UNSPECIFIED = 0;
    // The test passed.
    PASS = 1;
    // The test failed.
    FAIL = 2;
    // The test result should be ignored. For example, see http://junit.sourceforge.net/javadoc/org/junit/Ignore.html.
    IGNORED = 3;
    // The test result had an assumption which failed. For example, see http://junit.sourceforge.net/javadoc/org/junit/Assume.html.
    ASSUMPTION_FAILURE = 4;
    // There was an error while running the test.
    TEST_ERROR = 5;
    // The test was skipped. When the test was skipped the reason should be available in the skipped_reason field.
    TEST_SKIPPED = 6;
  }

  // The level of aggregation.
  enum AggregationLevel {
    AGGREGATION_LEVEL_UNSPECIFIED = 0;
    // All test results for an Invocation.
    INVOCATION = 1;
    // Test results for a module. This considers the module name and parameters in the `TestIdentifier` message.
    MODULE = 2;
    // Test results for a test package. This considers the module and all results sharing the same package from `test_class`
    // field in the `TestIdentifier` message. This is the string before the last "." in that field.
    PACKAGE = 3;
    // Test results for a test class. This considers the module and all results sharing the same `test_class` in the `TestIdentifier` message.
    CLASS = 4;
    // Test results for a method. This is currently not being generated.
    METHOD = 5;
  }

  // The type of the build.
  BuildType build_type = 1;

  // The ID of the build.
  string build_id = 2;

  // The provider of the build.
  string build_provider = 3;

  // The branch of the build.
  string branch = 4;

  // The target of the build.
  string build_target = 5;

  // The ID of the test result.
  string test_result_id = 6;

  // The ID of the work unit.
  string work_unit_id = 7;

  // The ID of the invocation.
  string invocation_id = 8;

  // A TestIdentifier describes how to identify a TestResult within an Invocaiton. This includes a hierarchy for where a TestResult is located.
  // Modules are identified by the module name and parameters. Different modules can have the same name but the paramereters must be different.
  // Next ID: 10
  message TestIdentifier {
    // Name of the module this test belongs to.
    string module = 1;

    // Parameters for the test module.
    repeated StringPair module_parameters = 2;

    // SHA256 hash of module_parameters used for cache and lookups. This is generated by the server and not exposed to the API.
    string module_parameters_hash = 3;

    // The name for a group of tests that are logically grouped together. Typically in the format of <package name>.<class name>.
    string test_class = 4;

    // The corresponding class name part of the test_class field.
    string class_name = 5;

    // The corresponding package name part of the test_class field.
    string package_name = 6;

    // The name of the test that is the smallest test execution unit.
    string method = 7;
  }

  // The aggregation details for an aggregated TestResult. Next ID: 4
  message AggregationDetail {
    // The level of aggregation.
    AggregationLevel aggregation_level = 1;

    // Aggregated results for the number of test results with each status.
    repeated StatusAggregation status_aggregation = 2;

    // Module level errors. Only set for invocation level aggregates.
    int64 module_errors = 3;
  }

  message StatusAggregation {
    // The test status.
    TestStatus status = 1;

    // The number of tests matching the aggregation.
    int64 num = 2;
  }

  // The test identifier.
  TestIdentifier test_identifier = 9;

  // The status of the test.
  TestStatus test_status = 10;

  // The debug information.
  DebugInfo debug_info = 11;

  // The timing information.
  Timing timing = 13;

  // The properties of the test result.
  repeated StringPair properties = 14;

  int32 attempt_number = 15;

  int32 run_number = 16;

  // The aggregation detail for an aggregated test result.
  AggregationDetail aggregation_detail = 17;

  // The hash of the test identifier.
  string test_identifier_hash = 18;

  // The id of the test identifier.
  string test_identifier_id = 19;

  // The id of the test definition.
  string test_definition_id = 20;

  // The number of flaky test cases.
  int64 flaky_test_cases = 21;

  // The id of the parent test identifier.
  string parent_test_identifier_id = 22;

  // The test definition.
  Test test = 23;

  int32 flaky_modules = 24;

  // The skipped reason.
  SkippedReason skipped_reason = 25;

  // The hour of the test result.
  string hour = 26;

  // The flat test id encoded by luci.
  // Used to cluster the BigQuery table to improve ad-hoc query.
  string test_id = 27;

  // The completion time of the invocation that has this test result.
  // Use to partition the BigQuery table.
  google.protobuf.Timestamp completion_time = 28;

  // The time when the BigQuery started inserting the row into the BigQuery
  // table.
  //
  // While this is approximately the same as the time the row became visible in the
  // BigQuery table, it will not match exactly due factors such as:
  // - BigQuery server processing delay,
  // - BigQuery server clock drift.
  // For these reasons, a row with a later insert_time may actually have
  // been visible before a row with an earlier insert_time.
  //
  // If you require timestamping that lines up with table visibility, e.g.
  // for incremental extracts, you may better off using the APPENDS Table-valued
  // function that is part of the BigQuery change history feature:
  // https://cloud.google.com/bigquery/docs/change-history
  google.protobuf.Timestamp insert_time = 29 [(bqschema.options).default_value = "CURRENT_TIMESTAMP()"];
}
