// Copyright 2024 The LUCI Authors.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package luci.resultdb.config;

import "go.chromium.org/luci/resultdb/proto/config/scheme.proto";

option go_package = "go.chromium.org/luci/resultdb/proto/config;configpb";

// Config is the service-wide configuration data for Luci ResultDB.
message Config {
  // Control the export of artifact from BatchCreateArtifact.
  // Going to be deprecate soon.
  BqArtifactExportConfig bq_artifact_export_config = 1;

  // Control the export of artifact in the artifactexporter service.
  BqArtifactExportConfig bq_artifact_exporter_service_config = 2;

  // Test schemes supported by the deployment.
  repeated Scheme schemes = 3;

  // Configures extended validation for the RootInvocation/WorkUnit
  // ProducerResource field.
  //
  // If a system is not specified in this list, it can still be
  // specified in a ProducerResource message, but:
  // - it will only be subject to basic validation, and
  // - a URL to the producing system's UI will not be generated.
  repeated ProducerSystem producer_systems = 4;

  // Configuration related to Android Build.
  AndroidBuild android_build = 5;
}

// BqArtifactExportConfig contains the configuration to export
// artifact content to BigQuery.
message BqArtifactExportConfig {
  // Whether the export to BigQuery is enabled.
  bool enabled = 1;
  // The percent of artifacts that should be exported to BigQuery.
  // This allows us to roll out the change incrementally.
  // This value must be an integer between [0, 100].
  int64 export_percent = 2;
}

// ProducerSystem configures a producer system in ResultDB. A producer system
// is a system which may be used in the ProducerResource message on a root
// invocation or work unit.
// Next ID: 7
message ProducerSystem {
  // The name of the producer system. E.g. "atp" or "buildbucket".
  string system = 1;

  // An RE2 regular expression matching allowed values of the ProducerResource.name field
  // for this system.
  //
  // Capture groups can be named to allow them to be used as variables in `url_template`
  // later on.
  // E.g. "^builds/(?P<build_id>[0-9]+)$" matches "builds/123456789" and captures
  // "123456789" as the `build_id` variable for use later in `url_template`.
  string name_pattern = 2;

  // An RE2 regular expression matching allowed values of the ProducerResource.data_realm field
  // for this system.
  //
  // E.g. "^(prod|test)$".
  string data_realm_pattern = 3;

  // If true, only allow the producer system to be used by trusted callers having the
  // `resultdb.workUnits.setProducerResource` or `resultdb.rootInvocations.setProducerResource`
  // permission. This can help ensure the integrity of the producer resource references
  // using this system, but is not suitable if tools running on developer workstations
  // will need to set this system.
  //
  // If false, allows any caller to set this system.
  bool validate_callers = 4;

  // A template used to generate a URL to a producer resource.
  //
  // To use a variable, use the syntax `${variable_name}`.
  // The defined variables are the named capture groups in `name_pattern`,
  // and the variable `data_realm`, which is the value of ProducerResource's
  // `data_realm` field.
  //
  // E.g. "https://ci.chromium.org/ui/b/${build_id}".
  string url_template = 5;

  // As per above, but allows overriding the URL template for specific data realms.
  // For example, the hostname of the URL may be different for different data realms.
  map<string, string> url_template_by_data_realm = 6;
}

// Configuration related to Android Build.
message AndroidBuild {
  // An RE2 regular expression matching allowed values of the AndroidBuildDescriptor.data_realm
  // and SubmittedAndroidBuild.data_realm fields.
  //
  // A data realm defines a unique deployment of Android Build with its own data store.
  // By convention, "prod" refers to the production environment.
  // Other environments typically start with a prefix from go/data-realms, e.g. "qual" or "test".
  // E.g. "qual-staging" is a staging deployment. See go/android-build-qa for all environments.
  //
  // E.g. "^(prod|qual-staging)$"
  string data_realm_pattern = 1;

  message ByDataRealmConfig {
    // Defines the URL template for a fully-specified Android build (branch, build_id, target)
    // in each Android Build data realm, for UI linking purposes. If a data realm allowed by
    // data_realm_pattern is not listed here, no URL will be generated for it.
    //
    // To use a variable, use the syntax `${variable_name}`.
    // The defined variables are:
    // - ${branch}: the Android build branch, e.g `git_main`.
    // - ${build_target}: the build target, e.g. `cf_x86_phone-userdebug`.
    // - ${build_id}: the build ID, e.g. `P81983588`.
    string full_build_url_template = 1;
  }

  // Defines data-realm-specific configuration.
  map<string, ByDataRealmConfig> data_realms = 2;
}
