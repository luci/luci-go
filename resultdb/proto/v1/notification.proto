// Copyright 2022 The LUCI Authors.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package luci.resultdb.v1;

import "google/protobuf/timestamp.proto";
import "go.chromium.org/luci/resultdb/proto/v1/common.proto";
import "go.chromium.org/luci/resultdb/proto/v1/root_invocation.proto";
import "go.chromium.org/luci/resultdb/proto/v1/test_aggregation.proto";
import "go.chromium.org/luci/resultdb/proto/v1/test_result.proto";

option go_package = "go.chromium.org/luci/resultdb/proto/v1;resultpb";
option java_package = "com.google.luci.resultdb.v1";
option java_multiple_files = true;

// A message notifying that an invocation has been finalized,
// i.e. that an invocation's test results are now immutable and are
// safe to be exported.
//
// The message is sent over the `v1.invocation_finalized` Cloud Pub/Sub
// topic in JSON-serialized form.
//
// Next id: 6.
message InvocationFinalizedNotification {
    // The name of the invocation that was finalized.
    // Format: invocations/{INVOCATION_ID}.
    string invocation = 1;

    // The LUCI realm that owns the invocation.
    // E.g. "chromium:ci".
    string realm = 2;

    // Whether this invocation is a root of the invocation graph for export purposes.
    //
    // To help downstream systems (like LUCI Analysis) make sense of test results,
    // and gather overall context for a result, ResultDB data export is centered
    // around export roots.
    //
    // See more in invocation.proto.
    bool is_export_root = 3;

    // The hostname of the luci.resultdb.v1.ResultDB service which
    // can be used to query more information about the invocation(s)
    // notified in this message.
    string resultdb_host = 4;

    // When the invocation was created.
    google.protobuf.Timestamp create_time = 5;
}

// A message notifying that a root invocation has been finalized,
// i.e. that a root invocation's test results are now immutable and are
// safe to be exported.
//
// The message is sent over the `v1.root_invocation_finalized` Cloud Pub/Sub
// topic in binary-serialized form.
//
// Next id: 3
message RootInvocationFinalizedNotification {
    // The root invocation that was finalized.
    luci.resultdb.v1.RootInvocation root_invocation = 1;

    // The hostname of the luci.resultdb.v1.ResultDB service which
    // can be used to query more information about the invocation(s)
    // notified in this message.
    string resultdb_host = 2;
}

// InvocationReadyForExportNotification notifies that the properties, test results
// and artifacts directly inside invocation `invocation`, within the context of
// export root `root_invocation`, are now immutable and ready for consumption
// by downstream systems.
//
// If a given invocation is included by multiple export roots, a message will
// be sent for each such root.
//
// When sent over v1.invocation_ready_for_export Cloud Pub/Sub, an attribute
// "luci_project" will be attached to the message, which will contain the
// LUCI Project of the `root_invocation_realm`.
//
// Next ID: 8.
message InvocationReadyForExportNotification {
    // The hostname of the luci.resultdb.v1.ResultDB service which
    // can be used to query more information about the invocation(s)
    // notified in this message.
    string resultdb_host = 6;

    // The export root with respect to which the export is occurring.
    //
    // Format: invocations/{ROOT_INVOCATION_ID}.
    string root_invocation = 1;

    // The LUCI realm that owns the root invocation.
    string root_invocation_realm = 2;

    // When the root invocation was created.
    google.protobuf.Timestamp root_create_time = 7;

    // The name of the ResultDB invocation included by root_invocation whose
    // immediate properties, test results and artifacts are now immutable
    // (in FINALIZING OR FINALIZED state). Note that child invocations included
    // by `invocation` may not yet be immutable.
    //
    // This may be equal to root_invocation, to indicate test results, artifacts
    // and properties immediately inside root_invocation are immutable and ready
    // for ingestion.
    //
    // Format: invocations/{INVOCATION_ID}.
    string invocation = 3;

    // The LUCI realm that owns `invocation`.
    string invocation_realm = 4;

    // The resolved sources for `invocation`, if any.
    //
    // As sources may be inherited, the sources resolved for the same
    // invocation may vary between export roots. This typically occurs when
    // a project uses testing task deduplication, and the different sources
    // deduplicate to the same testing task as they compile to
    // byte-for-byte-identical testing artifacts.
    luci.resultdb.v1.Sources sources = 5;
}

// A message to publish batches of test results from one or more work units
// within the same root invocation.
//
// The message is sent over the `v1.test_results` Cloud Pub/Sub topic in
// binary-serialized form. The size limit of the message is 10MB.
//
// Next id: 5
message TestResultsNotification {
    // A message representing the batch of test results grouped by work unit.
    // Next id: 3
    message TestResultsByWorkUnit {
        // The name of the work unit that the test results belong to.
        // Format: rootInvocations/{ROOT_INVOCATION_ID}/workUnits/{WORK_UNIT_ID}.
        string work_unit_name = 1;

        // A batch of test results in the same parent work units.
        repeated luci.resultdb.v1.TestResult test_results = 2;
    }

    // A list of batches of test results grouped by work unit in the same root
    // invocation.
    repeated TestResultsByWorkUnit test_results_by_work_unit = 1;

    // The hostname of the luci.resultdb.v1.ResultDB service which can be used
    // to query more information about the test results notified in this
    // message.
    string resultdb_host = 2;

    // The code sources tested, if known. This field is sourced from the root
    // invocation.
    luci.resultdb.v1.Sources sources = 3;

    // A deduplication key identifying this batch of test results within the
    // same root invocation.
    string deduplication_key = 4;
}

// A message notifying that work units have been finalized.
//
// The message is sent over the `v1.work_units` Cloud Pub/Sub topic in
// binary-serialized form.
//
// Next id: 4
message WorkUnitsNotification {
    // A message representing the work unit details.
    // Next id: 3
    message WorkUnitDetails {
        // The name of the work unit.
        // Format: rootInvocations/{ROOT_INVOCATION_ID}/workUnits/{WORK_UNIT_ID}.
        string work_unit_name = 1;

        // Whether the work unit or its contained test results have any
        // artifacts.
        bool has_artifacts = 2;
    }

    // A list of work units that have been finalized.
    repeated WorkUnitDetails work_units = 1;

    // The hostname of the luci.resultdb.v1.ResultDB service which can be used
    // to query more information about the work units notified in this message.
    string resultdb_host = 2;
}

// A message notifying that test aggregations are available.
//
// The message is sent over the `v1.test_aggregations` Cloud Pub/Sub topic in
// binary-serialized form.
//
// Note: test aggregations for one root invocation may be split over multiple
// messages as each message is limited to 10,000 aggregations or 10 MB
// (whichever is less).
//
// Next id: 5.
message TestAggregationsNotification {
    // The root invocation that the aggregations belong to.
    // Format: invocations/{ROOT_INVOCATION_ID}.
    string root_invocation = 1;

    // A batch of test aggregations.
    repeated luci.resultdb.v1.TestAggregation test_aggregations = 2;

    // The hostname of the luci.resultdb.v1.ResultDB service which can be used
    // to query more information about the test aggregations notified in this
    // message.
    string resultdb_host = 3;

    // The aggregation level of the test aggregations in this message.
    luci.resultdb.v1.AggregationLevel aggregation_level = 4;
}
